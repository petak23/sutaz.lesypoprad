<?phpnamespace App\AdminModule\Presenters\Forms\Slider;use Nette\Application\UI\Form;use Nette\Utils\Html;use Nette\Utils\Image;use DbTable;use Nette\Database;class EditSliderFormFactory {  /** @var DbTable\Slider */  private $slider;  /** @var DbTable\Hlavne_menu */  private $hlavne_menu;  /** @var array */  private $slider_i;  /** @var string */  private $wwwDir;  public function __construct(DbTable\Slider $slider, DbTable\Hlavne_menu $hlavne_menu) {		$this->slider = $slider;    $this->hlavne_menu = $hlavne_menu;	}    /**   * Edit hlavne menu form component factory.   * @return Nette\Application\UI\Form   */    public function create($slider_i, $wwwDir)  {    $this->slider_i = $slider_i;    $this->wwwDir = $wwwDir;    $form = new Form();		$form->addProtection();    $form->addHidden('id');    $form->addGroup();    $form->addUpload('subor', 'Obrázok slideru')				 ->setOption('description', 'Odporúčaný rozmer obrázku je: '.$this->slider_i['x'].'x'.$this->slider_i['y'].' alebo násobky tejto veľkosti. Inak môže dôjsť k deformácii alebo orezaniu obrázku pri ukladaní!' )				 ->addCondition(Form::FILLED)					->addRule(Form::IMAGE, 'Obrázok musí byť JPEG, PNG alebo GIF.')					->addRule(Form::MAX_FILE_SIZE, 'Maximálna veľkosť súboru je 1 MB.', 1024 * 1024 /* v bytech */);		$form->addText('nadpis', 'Nadpis:', 50, 50);		$form->addText('popis', 'Popis:', 50, 150);    $form->addText('poradie', 'Poradie:', 10, 10);    if ($slider_i['odkaz']) {      $form->addText('id_hlavne_menu', 'Id článku pre odkaz:', 5, 5)           ->setType('number')           ->addCondition(Form::FILLED)            ->addRule(Form::INTEGER, 'Id článku musí byť číslo!');    }    $form->addCheckbox("zobrazenie_null", " Obrázok sa zobrazí vždy")         ->addCondition(Form::EQUAL, TRUE)         ->toggle("zobr", FALSE);    $form->addGroup()->setOption('container', Html::el('fieldset')->id("zobr"));    $form->addText('zobrazenie', 'Zobrazenie:', 20, 20)         ->setOption('description', 'Zapíšte tie id hlavného menu, pre ktoré sa daný obrázok zobrazí. Ak viac id oddelte medzerou.');    $form->setCurrentGroup(NULL);    $form->addSubmit('uloz', 'Ulož')         ->setAttribute('class', 'btn btn-success')         ->onClick[] = array($this, 'editSliderFormSubmitted');    $form->addSubmit('cancel', 'Cancel')->setAttribute('class', 'btn btn-default')         ->setValidationScope(FALSE);		return $form;	}    /** Spracovanie vstupov z formulara   * @param Nette\Forms\Controls\SubmitButton $button Data formulara   */	public function editSliderFormSubmitted($button)	{    $values = $button->getForm()->getValues();		$data = $this->slider->find($values->id); //Nacitanie editovanej polozky		if ($values->zobrazenie_null) { $values->zobrazenie = NULL; }		unset($values->zobrazenie_null);    if ($this->slider_i['odkaz']) {      $values->id_hlavne_menu = (int)$values->id_hlavne_menu > 0 ? (int)$values->id_hlavne_menu : NULL;      if ($values->id_hlavne_menu !== NULL) { //Kontrola exzistencie id_hlavne_menu        if ($this->hlavne_menu->find($values->id_hlavne_menu) == FALSE) {          $button->addError('Zadali ste nesprávne číslo článku. Skúste znovu!');          return;        }      }    }    if ($values->subor && $values->subor->name != "") {      if ($values->subor->isImage()) {        $slider_dir = $this->wwwDir."/www/files/slider/";        $finalFileName = $this->_imageFileName($slider_dir, $values->subor->getSanitizedName());        $image_name = $slider_dir.$finalFileName;        $values->subor->move($image_name);        $image = Image::fromFile($image_name);        $image->resize($this->slider_i['x'], $this->slider_i['y'], Image::SHRINK_ONLY | Image::EXACT);        $image->save($image_name, 80);        if (is_file('www/files/slider/'.$data['subor'])) { unlink($slider_dir.$data['subor']); }				$values->subor = $finalFileName;      } else {        $button->addError('Zadali ste nesprávne číslo článku. Skúste znovu!');				unset($values->subor);        return;      }    } else { 			unset($values->subor);		}    try {      $this->slider->uloz($values, $values->id);		} catch (Database\DriverException $e) {			$button->addError($e->getMessage());		}	}    private function _imageFileName($dir, $fileName) {    $path_info = pathinfo($fileName);    $file = $path_info['filename'];    $ext = $path_info['extension'];    $additionalToken = 0;    if (file_exists($dir.$fileName)) {			do{					$additionalToken++;			} while (file_exists($dir.$file.$additionalToken. ".".$ext));		}    if ($additionalToken == 0) { $finalFileName = $fileName;    } else { $finalFileName = $file . $additionalToken . "." . $ext; }    return $finalFileName;  }}