<?phpnamespace App\FrontModule\Presenters\Forms\UserLog;use Nette\Application\UI\Form;use Nette\Security;use Nette\Utils\Html;//use Nette\Utils\Strings;use Nette\Utils\Image;use Nette\Utils\Random;use Language_support;use DbTable;/** * Formular editacie prihlaseneho uzivatela * Posledna zmena 06.03.2017 *  * @author     Ing. Peter VOJTECH ml. <petak23@gmail.com> * @copyright  Copyright (c) 2012 - 2017 Ing. Peter VOJTECH ml. * @license * @link       http://petak23.echo-msz.eu * @version    1.0.0 */class UserEditFormFactory {  /** @var Language_support\UserLog */  private $userLog_texts;  /** @var DbTable\User_profiles */  public $user_profiles;  /** @var Nette\Security\User */  public $user;  /** @var string */  private $wwwDir;  /** @var \Nette\Database\Table\ActiveRow|FALSE */  private $clen;  /** @param Security\User $user   */  public function __construct(Security\User $user, Language_support\UserLog $userLog_texts, DbTable\User_profiles $user_profiles) {    $this->user = $user;    $this->userLog_texts = $userLog_texts;    $this->user_profiles = $user_profiles;	}    /**    * Vratenie textu pre dany kluc a jazyk   * @param string $key - kluc daneho textu   * @return string - hodnota pre dany text */  private function trLang($key) {    return $this->userLog_texts->trText($key);  }  /**   * Formular pre editaciu prihlaseneho pouzivatela   * @param array $user_view_fields   * @param boolean $send_e_mail_news   * @param string $basePath   * @param string $wwwDir   * @param Nette\Database\Table\ActiveRow $clen   * @return Form */  public function create($user_view_fields, $send_e_mail_news, $basePath, $wwwDir, $clen)  {    $this->wwwDir = $wwwDir;    $this->clen = $clen;    $form = new Form();		$form->addProtection();    $form->addHidden('id');$form->addHidden('avatar_75');$form->addHidden('avatar_25');		$form->addText('meno', $this->trLang('UserEditForm_meno'), 50, 80)				 ->addRule(Form::MIN_LENGTH, $this->trLang('UserEditForm_meno_ar'), 3)				 ->setRequired($this->trLang('UserEditForm_meno_sr'));    $form->addText('priezvisko', $this->trLang('UserEditForm_priezvisko'), 50, 50)				 ->addRule(Form::MIN_LENGTH, $this->trLang('UserEditForm_priezvisko_ar'), 3)				 ->setRequired($this->trLang('UserEditForm_priezvisko_sr'));    $form->addText('username', $this->trLang('default_log_name').":", 50)->setDisabled(TRUE);    $form->addText('email', $this->trLang('default_email').":", 50)->setDisabled(TRUE);    $form->addText('registracia', $this->trLang('default_registracia').":", 50)->setDisabled(TRUE);    if ($user_view_fields["rok"]) {      $form->addText('rok', $this->trLang('UserEditForm_rok'), 4, 5)->setRequired(FALSE)           ->addRule(Form::RANGE, $this->trLang('UserEditForm_rok_ar'), [1900, StrFTime("%Y", Time())]);    }    if ($user_view_fields["telefon"]) { $form->addText('telefon', $this->trLang('UserEditForm_telefon'), 20, 20); }    if ($user_view_fields["poznamka"]) { $form->addText('poznamka', $this->trLang('UserEditForm_poznamka'), 50, 250); }    if ($user_view_fields["pohl"]) {      $form->addSelect('pohl', $this->trLang('UserEditForm_pohl'),                     ['M'=>$this->trLang('UserEditForm_m'),'Z'=>$this->trLang('UserEditForm_z')]);    }    if ($send_e_mail_news) {      $form->addSelect('news', $this->trLang('UserEditForm_news'),                       ['A'=>$this->trLang('UserEditForm_news_a'),'N'=>$this->trLang('UserEditForm_news_n')]);    }    if ($user_view_fields["avatar"]) {      $form->addUpload('avatar', $this->trLang('UserEditForm_avatar').":")         ->setOption('description', Html::el('p')->setHtml(              Html::el('img')->src($basePath.'/www/'.('/www/'.isset($this->clen->avatar_75) ? $this->clen->avatar_75 : 'ikonky/64/figurky_64.png'))->alt('avatar').              " ".$this->trLang('default_avatar_txt')))         ->addCondition(Form::FILLED)            ->addRule(Form::IMAGE, $this->trLang('UserEditForm_avatar_oi'))            ->addRule(Form::MAX_FILE_SIZE, $this->trLang('UserEditForm_avatar_ar'), 300 * 1024 /* v bytech */);    }		$form->addSubmit('uloz', $this->trLang('base_save'))         ->setAttribute('class', 'btn btn-success')         ->onClick[] = [$this, 'userEditFormSubmitted'];    $form->addSubmit('cancel', 'Cancel')->setAttribute('class', 'btn btn-default')         ->setValidationScope(FALSE);    $form->addText('prihlasenie', $this->trLang('default_last_log').":", 50)->setDisabled(TRUE);    $form->addText('pocet_pr', $this->trLang('default_count_log').":", 50)->setDisabled(TRUE);    $form->addText('created', $this->trLang('default_created').":", 50)->setDisabled(TRUE);    $form->addText('modified', $this->trLang('default_modified').":", 50)->setDisabled(TRUE);		return $form;	}    /**    * Spracovanie formulara   * @param Nette\Forms\Controls\SubmitButton $button Data formulara */	public function userEditFormSubmitted($button) {    $values = $button->getForm()->getValues(TRUE); 	//Nacitanie hodnot formulara		$id_user_profiles = $values['id']; // Ak je == 0 tak sa pridava    $values['modified'] = StrFTime("%Y-%m-%d %H:%M:%S", Time());    try {      if (isset($values['avatar']) && $values['avatar'] && $values['avatar']->name != "") {        if ($values['avatar']->isImage()){          $avatar_path = "files/".$id_user_profiles."/";          $path = $this->wwwDir."/www/".$avatar_path;          $pi = pathinfo($values['avatar']->getSanitizedName());          $ext = $pi['extension'];          if (is_dir($path)) {            foreach (glob("$path*.{jpg,jpeg,gif,png}", GLOB_BRACE) as $file) {              @unlink($file);            }          }	else { mkdir($path, 0777); }          $randfn = Random::generate(25)."_";          $avatar75_name = $randfn."75.".$ext;          $avatar25_name = $randfn."25.".$ext;          $values['avatar']->move($path.$avatar75_name);          $image = Image::fromFile($path.$avatar75_name);          $image->resize(75, 75, Image::SHRINK_ONLY);          $image->save($path.$avatar75_name, 90);          $values['avatar_75'] = $avatar_path.$avatar75_name;          copy($path.$avatar75_name, $path.$avatar25_name);          $thumb = Image::fromFile($path.$avatar25_name);          $thumb->resize(25, 25, Image::SHRINK_ONLY);          $thumb->save($path.$avatar25_name, 90);          $values['avatar_25'] = $avatar_path.$avatar25_name;        } else {          $button->addError($this->trLang('user_edit_avatar_err'));          unset($values['avatar_75'], $values['avatar_25']);        }      } else {        unset($values['avatar_75'], $values['avatar_25']);      }      unset($values['id'], $values['avatar']);      $uloz = $this->user_profiles->uloz($values, $id_user_profiles);//      if (isset($uloz['id']) && $this->clen->news != $values['news']) { //Ak doslo k zmene v posielani noviniek//        $news_key = new \PeterVojtech\News_key\NewsKeyControl($this->user_profiles, $this->user);//        $news_key->Spracuj($values['news'] == "A", $id_user_profiles);//      }     } catch (Security\AuthenticationException $e) {      $button->addError($e->getMessage());    }	}}